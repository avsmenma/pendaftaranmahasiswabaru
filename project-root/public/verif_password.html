<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title>Verifikasi Akun - Politeknik Negeri Pontianak</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
      }

      .header {
        background: #4a6c7d;
        color: white;
        padding: 20px 30px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .back-button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 18px;
        font-weight: 500;
        transition: opacity 0.3s;
      }

      .back-button:hover {
        opacity: 0.8;
      }

      .back-button i {
        font-size: 24px;
      }

      .main-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
      }

      .verify-card {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        padding: 50px 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .verify-header {
        text-align: center;
        margin-bottom: 35px;
      }

      .verify-header h2 {
        font-size: 32px;
        font-weight: 700;
        color: #333;
        margin-bottom: 12px;
      }

      .verify-header p {
        color: #666;
        font-size: 15px;
        line-height: 1.6;
      }

      .form-group {
        margin-bottom: 30px;
      }

      .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #333;
        font-size: 15px;
      }

      .input-wrapper {
        position: relative;
      }

      .form-control {
        width: 100%;
        padding: 16px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        letter-spacing: 2px;
        text-align: center;
        transition: all 0.3s;
        background: #f9f9f9;
      }

      .form-control:focus {
        outline: none;
        border-color: #4a6c7d;
        background: white;
      }

      .form-control::placeholder {
        color: #aaa;
        letter-spacing: normal;
      }

      .btn-submit {
        width: 100%;
        padding: 16px;
        background: #4a6c7d;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-submit:hover {
        background: #3a5866;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(74, 108, 125, 0.3);
      }

      .btn-submit:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .resend-code {
        text-align: center;
        margin-top: 25px;
        font-size: 14px;
        color: #666;
      }

      .resend-code button {
        background: none;
        border: none;
        color: #4a6c7d;
        font-weight: 600;
        cursor: pointer;
        text-decoration: underline;
        padding: 0;
      }

      .resend-code button:hover {
        opacity: 0.8;
      }

      .resend-code button:disabled {
        color: #ccc;
        cursor: not-allowed;
      }

      .timer {
        color: #4a6c7d;
        font-weight: 600;
      }

      /* Notification */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 18px 24px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        transform: translateX(120%);
        transition: transform 0.3s ease;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid #4caf50;
      }

      .notification.error {
        border-left: 4px solid #f44336;
      }

      .notification.info {
        border-left: 4px solid #2196f3;
      }

      .notification i {
        font-size: 24px;
      }

      .notification.success i {
        color: #4caf50;
      }

      .notification.error i {
        color: #f44336;
      }

      .notification.info i {
        color: #2196f3;
      }

      .notification-content p {
        margin: 0;
        line-height: 1.4;
      }

      .notification-title {
        font-weight: 600;
        font-size: 15px;
        color: #333;
        margin-bottom: 4px;
      }

      .notification-message {
        font-size: 14px;
        color: #666;
      }

      /* Loading Overlay */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }

      .loading-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
      }

      .loading-content i {
        font-size: 50px;
        color: #4a6c7d;
        margin-bottom: 20px;
      }

      .loading-content p {
        color: #4a6c7d;
        font-weight: 600;
        font-size: 16px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .verify-card {
          padding: 40px 30px;
        }

        .verify-header h2 {
          font-size: 26px;
        }

        .header {
          padding: 15px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <button class="back-button" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
        <span>Kembali</span>
      </button>
    </div>

    <div class="main-container">
      <div class="verify-card">
        <div class="verify-header">
          <h2>Verifikasi Akun</h2>
          <p>
            Kami telah mengirim kode verifikasi ke email Anda. Masukkan kode
            verifikasi untuk melanjutkan proses reset password
          </p>
        </div>

        <form id="verify-form">
          <div class="form-group">
            <label for="verification-code">Kode verifikasi</label>
            <div class="input-wrapper">
              <input
                type="text"
                id="verification-code"
                class="form-control"
                placeholder="Masukkan 6 digit kode verifikasi"
                maxlength="6"
                pattern="[0-9]{6}"
                required
              />
            </div>
          </div>

          <button type="submit" class="btn-submit" id="btn-submit">
            Selanjutnya
          </button>
        </form>

        <div class="resend-code">
          <p>
            Tidak menerima kode?
            <button type="button" id="resend-btn" onclick="resendCode()">
              Kirim ulang
            </button>
            <span id="timer-text"></span>
          </p>
        </div>
      </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
      <i class="fas fa-check-circle"></i>
      <div class="notification-content">
        <p class="notification-title" id="notification-title">Berhasil</p>
        <p class="notification-message" id="notification-message">
          Kode verifikasi valid
        </p>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-content">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Memverifikasi kode...</p>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000";
      let resendTimer = 0;
      let timerInterval;

      // Check if email exists in session
      window.addEventListener("DOMContentLoaded", function () {
        const resetEmail = sessionStorage.getItem("resetEmail");
        if (!resetEmail) {
          showNotification(
            "error",
            "Error",
            "Session tidak valid. Silakan mulai dari awal."
          );
          setTimeout(() => {
            window.location.href = "reset_password.html";
          }, 2000);
        }

        // Start resend timer
        startResendTimer(60);
      });

      // Go back function
      function goBack() {
        window.history.back();
      }

      // Form submission
      document
        .getElementById("verify-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const code = document
            .getElementById("verification-code")
            .value.trim();
          const email = sessionStorage.getItem("resetEmail");
          const btnSubmit = document.getElementById("btn-submit");

          if (!code) {
            showNotification(
              "error",
              "Error",
              "Mohon masukkan kode verifikasi"
            );
            return;
          }

          if (code.length !== 6) {
            showNotification(
              "error",
              "Kode Tidak Valid",
              "Kode verifikasi harus 6 digit"
            );
            return;
          }

          // Show loading
          showLoading(true);
          btnSubmit.disabled = true;
          btnSubmit.textContent = "Memverifikasi...";

          try {
            const response = await fetch(`${API_URL}/api/verify-reset-code`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: email,
                code: code,
              }),
            });

            const data = await response.json();

            showLoading(false);
            btnSubmit.disabled = false;
            btnSubmit.textContent = "Selanjutnya";

            if (data.success) {
              showNotification("success", "Berhasil", "Kode verifikasi valid");

              // Store verification token
              sessionStorage.setItem("verificationToken", data.token || code);

              // Redirect to new password page
              setTimeout(() => {
                window.location.href = "password_baru.html";
              }, 1500);
            } else {
              showNotification(
                "error",
                "Kode Salah",
                data.message || "Kode verifikasi tidak valid atau sudah expired"
              );
            }
          } catch (error) {
            showLoading(false);
            btnSubmit.disabled = false;
            btnSubmit.textContent = "Selanjutnya";
            console.error("Verification error:", error);
            showNotification(
              "error",
              "Kesalahan Koneksi",
              "Tidak dapat terhubung ke server"
            );
          }
        });

      // Resend code function
      async function resendCode() {
        const email = sessionStorage.getItem("resetEmail");
        const resendBtn = document.getElementById("resend-btn");

        if (resendTimer > 0) {
          return;
        }

        resendBtn.disabled = true;

        try {
          const response = await fetch(`${API_URL}/api/reset_password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email: email }),
          });

          const data = await response.json();

          if (data.success) {
            showNotification(
              "success",
              "Berhasil",
              "Kode verifikasi baru telah dikirim"
            );
            startResendTimer(60);
          } else {
            showNotification("error", "Gagal", "Gagal mengirim ulang kode");
            resendBtn.disabled = false;
          }
        } catch (error) {
          console.error("Resend error:", error);
          showNotification(
            "error",
            "Kesalahan",
            "Tidak dapat mengirim ulang kode"
          );
          resendBtn.disabled = false;
        }
      }

      // Start resend timer
      function startResendTimer(seconds) {
        resendTimer = seconds;
        const resendBtn = document.getElementById("resend-btn");
        const timerText = document.getElementById("timer-text");

        resendBtn.disabled = true;

        if (timerInterval) {
          clearInterval(timerInterval);
        }

        timerInterval = setInterval(() => {
          resendTimer--;
          timerText.textContent = ` (${resendTimer}s)`;
          timerText.classList.add("timer");

          if (resendTimer <= 0) {
            clearInterval(timerInterval);
            resendBtn.disabled = false;
            timerText.textContent = "";
          }
        }, 1000);
      }

      // Only allow numbers in verification code
      document
        .getElementById("verification-code")
        .addEventListener("input", function (e) {
          this.value = this.value.replace(/[^0-9]/g, "");
        });

      // Show notification function
      function showNotification(type, title, message) {
        const notification = document.getElementById("notification");
        const icon = notification.querySelector("i");
        const titleElement = document.getElementById("notification-title");
        const messageElement = document.getElementById("notification-message");

        titleElement.textContent = title;
        messageElement.textContent = message;
        notification.className = "notification " + type;

        if (type === "success") {
          icon.className = "fas fa-check-circle";
        } else if (type === "error") {
          icon.className = "fas fa-exclamation-circle";
        } else if (type === "info") {
          icon.className = "fas fa-info-circle";
        }

        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 4000);
      }

      // Show/hide loading overlay
      function showLoading(show) {
        const overlay = document.getElementById("loading-overlay");
        overlay.style.display = show ? "flex" : "none";
      }
    </script>
  </body>
</html>
