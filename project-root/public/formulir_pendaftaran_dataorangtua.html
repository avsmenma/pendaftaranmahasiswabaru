<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Orang Tua - Sistem Penerimaan Mahasiswa</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style/dataorangtua.css" />
    <style>
      /* ==================== AUTO LOGOUT MODAL STYLES ==================== */
      .idle-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .idle-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .idle-modal {
        background: white;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .idle-overlay.show .idle-modal {
        transform: scale(1);
      }

      .idle-icon {
        width: 80px;
        height: 80px;
        background: #fef3c7;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
      }

      .idle-icon i {
        font-size: 32px;
        color: #f59e0b;
      }

      .idle-modal h3 {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 12px;
      }

      .idle-modal p {
        font-size: 16px;
        color: #6b7280;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .countdown-display {
        font-size: 48px;
        font-weight: 700;
        color: #3182ce;
        margin-bottom: 32px;
        font-family: "Inter", monospace;
      }

      .idle-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .btn-stay,
      .btn-logout-now {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-stay {
        background: #10b981;
        color: white;
      }

      .btn-stay:hover {
        background: #059669;
        transform: translateY(-1px);
      }

      .btn-logout-now {
        background: #ef4444;
        color: white;
      }

      .btn-logout-now:hover {
        background: #dc2626;
        transform: translateY(-1px);
      }

      @media (max-width: 480px) {
        .idle-modal {
          padding: 24px;
          margin: 20px;
        }

        .idle-buttons {
          flex-direction: column;
        }

        .btn-stay,
        .btn-logout-now {
          width: 100%;
          justify-content: center;
        }
      }

      /* Logout Confirmation Modal */
      .logout-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .logout-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .logout-modal {
        background: white;
        border-radius: 16px;
        padding: 32px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .logout-overlay.show .logout-modal {
        transform: scale(1);
      }

      .logout-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        animation: pulse-red 2s infinite;
      }

      .logout-icon i {
        font-size: 32px;
        color: white;
      }

      @keyframes pulse-red {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        70% {
          transform: scale(1.05);
          box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
      }

      .logout-modal h3 {
        font-size: 24px;
        font-weight: 700;
        color: #1a365d;
        margin-bottom: 12px;
      }

      .logout-modal p {
        font-size: 16px;
        color: #4a5568;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .logout-buttons {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .btn-cancel {
        flex: 1;
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
      }

      .btn-cancel:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
      }

      .btn-confirm-logout {
        flex: 1;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
      }

      .btn-confirm-logout:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .btn-cancel i,
      .btn-confirm-logout i {
        font-size: 16px;
      }

      @media (max-width: 480px) {
        .logout-modal {
          padding: 24px;
          margin: 20px;
        }

        .logout-icon {
          width: 60px;
          height: 60px;
        }

        .logout-icon i {
          font-size: 24px;
        }

        .logout-modal h3 {
          font-size: 20px;
        }

        .logout-buttons {
          flex-direction: column;
        }

        .btn-cancel,
        .btn-confirm-logout {
          width: 100%;
        }
      }
    </style>

    <!-- Notification CSS -->
    <style>
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        max-width: 400px;
        transform: translateX(500px);
        transition: all 0.3s ease;
        z-index: 10000;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid #10b981;
      }

      .notification.success i {
        color: #10b981;
      }

      .notification.error {
        border-left: 4px solid #ef4444;
      }

      .notification.error i {
        color: #ef4444;
      }

      .notification.info {
        border-left: 4px solid #3182ce;
      }

      .notification.info i {
        color: #3182ce;
      }

      .notification i {
        font-size: 20px;
        flex-shrink: 0;
      }

      .notification div p {
        margin: 0;
        line-height: 1.4;
      }

      .notification #notification-title {
        font-weight: 600;
        font-size: 14px;
        color: #1f2937;
        margin-bottom: 2px;
      }

      .notification #notification-message {
        font-size: 13px;
        color: #6b7280;
      }

      @media (max-width: 480px) {
        .notification {
          right: 10px;
          left: 10px;
          min-width: auto;
          max-width: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="profile-section">
          <div class="profile-avatar" id="profile-avatar">P</div>
          <div class="profile-name" id="profile-name">Loading...</div>
          <div class="profile-email" id="profile-email">Loading...</div>
        </div>

        <nav class="menu">
          <a href="dashboard.html" class="menu-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a href="#" class="menu-item active">
            <i class="fas fa-file-alt"></i>
            <span>Formulir Pendaftaran</span>
          </a>
          <a href="#" class="menu-item">
            <i class="fas fa-bell"></i>
            <span>Pengumuman</span>
          </a>
          <a href="#" class="menu-item">
            <i class="fas fa-user"></i>
            <span>Profil</span>
          </a>
        </nav>

        <div class="logout-section">
          <button class="logout-btn" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="header">
          <h1>Formulir Pendaftaran</h1>
          <div class="header-right">
            <button class="notification-btn">
              <i class="fas fa-bell"></i>
              <span class="notification-badge"></span>
            </button>
          </div>
        </header>

        <div class="content">
          <!-- Form Header -->
          <div class="form-header-card">
            <div>
              <h2>Formulir Pendaftaran Mahasiswa Baru</h2>
              <p>
                Lengkapi semua informasi yang diperlukan untuk menyelesaikan
                pendaftaran
              </p>
            </div>
            <div class="step-badge">3 dari 5</div>
          </div>

          <!-- Steps -->
          <div class="steps-container">
            <div class="steps">
              <div class="step completed">
                <div class="step-icon">
                  <i class="fas fa-check"></i>
                </div>
                <div class="step-title">Data Pribadi</div>
                <div class="step-subtitle">Informasi Personal dan Kontak</div>
              </div>
              <div class="step completed">
                <div class="step-icon">
                  <i class="fas fa-check"></i>
                </div>
                <div class="step-title">Data Akademik</div>
                <div class="step-subtitle">
                  Informasi Pendidikan dan Jurusan
                </div>
              </div>
              <div class="step active">
                <div class="step-icon">
                  <i class="fas fa-users"></i>
                </div>
                <div class="step-title">Data Orang Tua</div>
                <div class="step-subtitle">Informasi orang tua/wali</div>
              </div>
              <div class="step">
                <div class="step-icon">
                  <i class="fas fa-file-upload"></i>
                </div>
                <div class="step-title">Upload Dokumen</div>
                <div class="step-subtitle">Berkas dan Ijazah/SKHUN</div>
              </div>
              <div class="step">
                <div class="step-icon">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="step-title">Review & Submit</div>
                <div class="step-subtitle">Upload berkas pendukung</div>
              </div>
            </div>

            <div class="progress-bar-container">
              <div class="progress-percentage">40%</div>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 40%"
              ></div>
            </div>
          </div>

          <!-- Form Content -->
          <div class="form-card">
            <div class="form-section-header">
              <i class="fas fa-users"></i>
              <div>
                <h3>Data Orang Tua</h3>
                <p>Informasi orang tua/wali</p>
              </div>
            </div>

            <div class="info-banner">
              <i class="fas fa-info-circle"></i>
              Lengkapi data orang tua yang dapat dihubungi
            </div>

            <form id="orangTuaForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="namaAyah">Nama Ayah</label>
                  <input
                    type="text"
                    id="namaAyah"
                    class="form-control"
                    placeholder="Masukkan nama lengkap ayah"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="pekerjaanAyah">Pekerjaan Ayah</label>
                  <input
                    type="text"
                    id="pekerjaanAyah"
                    class="form-control"
                    placeholder="Contoh: Pegawai Swasta"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="nohpAyah">No. HP Ayah</label>
                  <input
                    type="tel"
                    id="nohpAyah"
                    class="form-control"
                    placeholder="Contoh: 081234567890"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="penghasilanAyah"
                    >Penghasilan Ayah (Perbulan)</label
                  >
                  <select id="penghasilanAyah" class="form-control" required>
                    <option value="">Pilih Range Penghasilan</option>
                    <option value="< 1 Juta">< 1 Juta</option>
                    <option value="1 - 3 Juta">1 - 3 Juta</option>
                    <option value="3 - 5 Juta">3 - 5 Juta</option>
                    <option value="5 - 10 Juta">5 - 10 Juta</option>
                    <option value="> 10 Juta">> 10 Juta</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="namaIbu">Nama Ibu</label>
                  <input
                    type="text"
                    id="namaIbu"
                    class="form-control"
                    placeholder="Masukkan nama lengkap ibu"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="pekerjaanIbu">Pekerjaan Ibu</label>
                  <input
                    type="text"
                    id="pekerjaanIbu"
                    class="form-control"
                    placeholder="Contoh: Ibu Rumah Tangga"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="nohpIbu">No. HP Ibu</label>
                  <input
                    type="tel"
                    id="nohpIbu"
                    class="form-control"
                    placeholder="Contoh: 081234567890"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="penghasilanIbu">Penghasilan Ibu (Perbulan)</label>
                  <select id="penghasilanIbu" class="form-control" required>
                    <option value="">Pilih Range Penghasilan</option>
                    <option value="< 1 Juta">< 1 Juta</option>
                    <option value="1 - 3 Juta">1 - 3 Juta</option>
                    <option value="3 - 5 Juta">3 - 5 Juta</option>
                    <option value="5 - 10 Juta">5 - 10 Juta</option>
                    <option value="> 10 Juta">> 10 Juta</option>
                  </select>
                </div>

                <div class="form-group full-width">
                  <label for="alamatAyah">Alamat Ayah</label>
                  <textarea
                    id="alamatAyah"
                    class="form-control"
                    placeholder="Masukkan alamat lengkap ayah"
                    required
                  ></textarea>
                </div>

                <div class="form-group full-width">
                  <label for="alamatIbu">Alamat Ibu</label>
                  <textarea
                    id="alamatIbu"
                    class="form-control"
                    placeholder="Masukkan alamat lengkap ibu"
                    required
                  ></textarea>
                </div>
              </div>

              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="handlePrevious()"
                >
                  <i class="fas fa-arrow-left"></i>
                  Sebelumnya
                </button>
                <div style="display: flex; gap: 12px">
                  <button
                    type="button"
                    class="btn btn-outline"
                    onclick="handleSaveDraft()"
                  >
                    <i class="fas fa-save"></i>
                    Simpan Draft
                  </button>
                  <button type="submit" class="btn btn-primary">
                    Selanjutnya
                    <i class="fas fa-arrow-right"></i>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <!-- Idle Warning Modal -->
    <div class="idle-overlay" id="idleOverlay">
      <div class="idle-modal">
        <div class="idle-icon">
          <i class="fas fa-clock"></i>
        </div>
        <h3>Sesi Anda Hampir Berakhir</h3>
        <p>
          Anda tidak aktif selama beberapa waktu. Sesi Anda akan berakhir dalam:
        </p>
        <div class="countdown-display" id="countdownDisplay">60</div>
        <div class="idle-buttons">
          <button class="btn-stay" onclick="stayLoggedIn()">
            <i class="fas fa-check"></i> Tetap Login
          </button>
          <button class="btn-logout-now" onclick="logoutNow()">
            <i class="fas fa-sign-out-alt"></i> Logout Sekarang
          </button>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="logout-overlay" id="logoutOverlay">
      <div class="logout-modal">
        <div class="logout-icon">
          <i class="fas fa-sign-out-alt"></i>
        </div>
        <h3>Konfirmasi Logout</h3>
        <p>
          Apakah Anda yakin ingin keluar dari sistem? Semua data yang belum
          disimpan akan hilang.
        </p>
        <div class="logout-buttons">
          <button class="btn-cancel" onclick="cancelLogout()">
            <i class="fas fa-times"></i> Batal
          </button>
          <button class="btn-confirm-logout" onclick="confirmLogout()">
            <i class="fas fa-sign-out-alt"></i> Ya, Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
      <i class="fas fa-check-circle"></i>
      <div>
        <p id="notification-title">Berhasil</p>
        <p id="notification-message">Data berhasil disimpan</p>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000";

      // ==================== KONFIGURASI AUTO-LOGOUT ====================
      const IDLE_TIME = 1 * 60 * 1000; // 1 menit
      const WARNING_TIME = 60; // 60 detik peringatan sebelum logout

      let idleTimer = null;
      let warningTimer = null;
      let countdownInterval = null;
      let countdownSeconds = 60;

      // ==================== FUNGSI IDLE DETECTION ====================
      function resetIdleTimer() {
        // Clear existing timers
        clearTimeout(idleTimer);
        clearTimeout(warningTimer);
        clearInterval(countdownInterval);

        // Hide warning modal if showing
        hideIdleWarning();

        // Set new idle timer
        idleTimer = setTimeout(() => {
          showIdleWarning();
        }, IDLE_TIME);
      }

      function showIdleWarning() {
        const overlay = document.getElementById("idleOverlay");
        overlay.classList.add("show");

        // Reset countdown
        countdownSeconds = WARNING_TIME;
        updateCountdownDisplay();

        // Start countdown
        countdownInterval = setInterval(() => {
          countdownSeconds--;
          updateCountdownDisplay();

          if (countdownSeconds <= 0) {
            autoLogout();
          }
        }, 1000);
      }

      function hideIdleWarning() {
        const overlay = document.getElementById("idleOverlay");
        overlay.classList.remove("show");
        clearInterval(countdownInterval);
      }

      function updateCountdownDisplay() {
        const display = document.getElementById("countdownDisplay");
        display.textContent = countdownSeconds;

        // Change color based on urgency
        if (countdownSeconds <= 10) {
          display.style.color = "#ef4444";
        } else if (countdownSeconds <= 30) {
          display.style.color = "#f59e0b";
        } else {
          display.style.color = "#3182ce";
        }
      }

      function stayLoggedIn() {
        hideIdleWarning();
        resetIdleTimer();
      }

      function logoutNow() {
        performLogout();
      }

      function autoLogout() {
        clearInterval(countdownInterval);
        performAutoLogout();
      }

      function performAutoLogout() {
        // Simpan informasi logout
        const logoutInfo = {
          reason: "idle_timeout",
          timestamp: new Date().toISOString(),
          lastPage: window.location.pathname,
        };

        console.log("Logout Info:", logoutInfo);

        // Clear session storage - use consistent keys
        sessionStorage.removeItem("currentUser");
        sessionStorage.removeItem("user");
        sessionStorage.removeItem("resetEmail");
        sessionStorage.removeItem("verificationToken");

        // Redirect ke halaman login
        alert(
          "Sesi Anda telah berakhir karena tidak aktif. Silakan login kembali."
        );
        window.location.href = "index.html";
      }

      // ==================== EVENT LISTENERS UNTUK AKTIVITAS ====================
      const activityEvents = [
        "mousedown",
        "mousemove",
        "keypress",
        "scroll",
        "touchstart",
        "click",
      ];

      // Add activity listeners
      activityEvents.forEach((event) => {
        document.addEventListener(event, resetIdleTimer, true);
      });

      // ==================== PAGE VISIBILITY API ====================
      document.addEventListener("visibilitychange", function () {
        if (!document.hidden) {
          // Reset timer when user comes back to the page
          resetIdleTimer();
        }
      });

      // ==================== USER DATA LOADING ====================
      let currentUser = null;

      // Check submission status
      async function checkSubmissionStatus() {
        const currentUser = JSON.parse(sessionStorage.getItem("currentUser"));
        if (!currentUser) {
          return false;
        }

        try {
          const response = await fetch(
            `${API_URL}/api/check-submission/${currentUser.id}`
          );

          if (response.ok) {
            const result = await response.json();
            return result.hasSubmitted || false;
          }
        } catch (error) {
          console.error("Error checking submission status:", error);
        }

        return false;
      }

      // Load user data on page load
      window.addEventListener("DOMContentLoaded", async function () {
        // Check if user is logged in - normalize to use 'currentUser' key
        const userData =
          sessionStorage.getItem("currentUser") ||
          sessionStorage.getItem("user");
        if (!userData) {
          window.location.href = "index.html";
          return;
        }

        // Normalize to use 'currentUser' key
        sessionStorage.setItem("currentUser", userData);
        currentUser = JSON.parse(userData);

        // Check if already submitted, redirect to review page
        const hasSubmitted = await checkSubmissionStatus();
        if (hasSubmitted) {
          window.location.href = "formulir_pendaftaran_reviewandsubmit.html";
          return;
        }

        loadUserData();
        loadOrangTuaData();

        // Start idle timer immediately
        resetIdleTimer();
      });

      // Load user data from API
      async function loadUserData() {
        try {
          const response = await fetch(
            `${API_URL}/api/user-data/${currentUser.id}`
          );
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              updateUserInterface(result.data);
            }
          } else {
            // Fallback to session storage data
            updateUserInterfaceFallback();
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          // Fallback to session storage data
          updateUserInterfaceFallback();
        }
      }

      // Load existing orang tua data
      async function loadOrangTuaData() {
        try {
          const response = await fetch(
            `${API_URL}/api/orang-tua-data/${currentUser.id}`
          );
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              populateForm(result.data);
            }
          }
        } catch (error) {
          console.error("Error loading orang tua data:", error);
        }
      }

      // Update interface with data from database
      function updateUserInterface(userData) {
        const name = userData.nama_lengkap || currentUser.username || "User";
        const email =
          userData.email || currentUser.username || "user@example.com";

        // Update sidebar profile
        document.getElementById("profile-name").textContent = name;
        document.getElementById("profile-email").textContent = email;

        // Update avatars with initials
        const initials = getInitials(name);
        document.getElementById("profile-avatar").textContent = initials;
      }

      // Fallback using session storage data
      function updateUserInterfaceFallback() {
        const name = currentUser.nama_lengkap || currentUser.username || "User";
        const email =
          currentUser.email || currentUser.username || "user@example.com";

        // Update sidebar profile
        document.getElementById("profile-name").textContent = name;
        document.getElementById("profile-email").textContent = email;

        // Update avatars with initials
        const initials = getInitials(name);
        document.getElementById("profile-avatar").textContent = initials;
      }

      // Get initials from name
      function getInitials(name) {
        const words = name.trim().split(" ");
        if (words.length >= 2) {
          return (words[0][0] + words[1][0]).toUpperCase();
        } else if (words.length === 1) {
          return words[0].substring(0, 2).toUpperCase();
        }
        return "U";
      }

      // Populate form with existing data
      function populateForm(data) {
        document.getElementById("namaAyah").value = data.nama_ayah || "";
        document.getElementById("pekerjaanAyah").value =
          data.pekerjaan_ayah || "";
        document.getElementById("nohpAyah").value = data.nohp_ayah || "";
        document.getElementById("penghasilanAyah").value =
          data.penghasilan_ayah || "";
        document.getElementById("alamatAyah").value = data.alamat_ayah || "";

        document.getElementById("namaIbu").value = data.nama_ibu || "";
        document.getElementById("pekerjaanIbu").value =
          data.pekerjaan_ibu || "";
        document.getElementById("nohpIbu").value = data.nohp_ibu || "";
        document.getElementById("penghasilanIbu").value =
          data.penghasilan_ibu || "";
        document.getElementById("alamatIbu").value = data.alamat_ibu || "";
      }

      // Menu navigation
      const menuItems = document.querySelectorAll(".menu-item");
      menuItems.forEach((item) => {
        item.addEventListener("click", function (e) {
          if (this.getAttribute("href") !== "#") return;
          e.preventDefault();
          menuItems.forEach((m) => m.classList.remove("active"));
          this.classList.add("active");
        });
      });

      // Form submission
      document
        .getElementById("orangTuaForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Get form data
          const formData = {
            namaAyah: document.getElementById("namaAyah").value,
            pekerjaanAyah: document.getElementById("pekerjaanAyah").value,
            nohpAyah: document.getElementById("nohpAyah").value,
            penghasilanAyah: document.getElementById("penghasilanAyah").value,
            alamatAyah: document.getElementById("alamatAyah").value,
            namaIbu: document.getElementById("namaIbu").value,
            pekerjaanIbu: document.getElementById("pekerjaanIbu").value,
            nohpIbu: document.getElementById("nohpIbu").value,
            penghasilanIbu: document.getElementById("penghasilanIbu").value,
            alamatIbu: document.getElementById("alamatIbu").value,
          };

          // Validate required fields
          for (let key in formData) {
            if (!formData[key] || formData[key].trim() === "") {
              showNotification(
                "error",
                "Error",
                "Mohon lengkapi semua field yang wajib diisi"
              );
              return;
            }
          }

          // Save to database
          try {
            const response = await fetch(`${API_URL}/api/save-orangtua`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                userId: currentUser.id,
                ...formData,
              }),
            });

            const result = await response.json();
            if (result.success) {
              showNotification(
                "success",
                "Berhasil",
                "Data orang tua berhasil disimpan! Melanjutkan ke Upload Dokumen..."
              );

              // Redirect after 1.5 seconds
              setTimeout(() => {
                window.location.href =
                  "formulir_pendaftaran_uploaddokumen.html";
              }, 1500);
            } else {
              showNotification(
                "error",
                "Error",
                "Gagal menyimpan data: " + result.message
              );
            }
          } catch (error) {
            console.error("Error saving data:", error);
            showNotification(
              "error",
              "Kesalahan",
              "Terjadi kesalahan saat menyimpan data. Silakan coba lagi."
            );
          }
        });

      // Handle previous button
      function handlePrevious() {
        if (
          confirm(
            "Kembali ke Data Akademik? Perubahan yang belum disimpan akan hilang."
          )
        ) {
          window.location.href = "formulir_pendaftaran_dataakademik.html";
        }
      }

      // Handle save draft
      async function handleSaveDraft() {
        const formData = {
          namaAyah: document.getElementById("namaAyah").value,
          pekerjaanAyah: document.getElementById("pekerjaanAyah").value,
          nohpAyah: document.getElementById("nohpAyah").value,
          penghasilanAyah: document.getElementById("penghasilanAyah").value,
          alamatAyah: document.getElementById("alamatAyah").value,
          namaIbu: document.getElementById("namaIbu").value,
          pekerjaanIbu: document.getElementById("pekerjaanIbu").value,
          nohpIbu: document.getElementById("nohpIbu").value,
          penghasilanIbu: document.getElementById("penghasilanIbu").value,
          alamatIbu: document.getElementById("alamatIbu").value,
        };

        // Also save to database (like other forms)
        try {
          const response = await fetch(`${API_URL}/api/save-orangtua`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId: currentUser.id,
              ...formData,
            }),
          });

          const result = await response.json();
          if (result.success) {
            saveFormData("orangTua", formData);
            showNotification("success", "Berhasil", "Draft berhasil disimpan!");
          } else {
            showNotification(
              "error",
              "Error",
              "Gagal menyimpan draft: " + result.message
            );
          }
        } catch (error) {
          console.error("Error saving draft:", error);
          showNotification(
            "error",
            "Kesalahan",
            "Terjadi kesalahan saat menyimpan draft. Silakan coba lagi."
          );
        }
      }

      // Logout function
      function handleLogout() {
        showLogoutModal();
      }

      // Show logout confirmation modal
      function showLogoutModal() {
        const overlay = document.getElementById("logoutOverlay");
        overlay.classList.add("show");
      }

      // Cancel logout
      function cancelLogout() {
        const overlay = document.getElementById("logoutOverlay");
        overlay.classList.remove("show");
      }

      // Confirm logout
      function confirmLogout() {
        performLogout();
      }

      function performLogout() {
        // Clear session storage
        sessionStorage.removeItem("currentUser");
        sessionStorage.removeItem("user");
        sessionStorage.removeItem("resetEmail");
        sessionStorage.removeItem("verificationToken");

        // Redirect to login page
        window.location.href = "index.html";
      }

      // Close modal when clicking outside
      document.addEventListener("DOMContentLoaded", function () {
        const logoutOverlay = document.getElementById("logoutOverlay");
        if (logoutOverlay) {
          logoutOverlay.addEventListener("click", function (e) {
            if (e.target === this) {
              cancelLogout();
            }
          });
        }
      });

      // Storage functions (using in-memory storage instead of localStorage)
      window.formDataStorage = window.formDataStorage || {};

      function saveFormData(step, data) {
        window.formDataStorage[step] = data;
        console.log("Data saved for step:", step, data);
      }

      function loadSavedData() {
        const savedData = window.formDataStorage["orangTua"];
        if (savedData) {
          document.getElementById("namaAyah").value = savedData.namaAyah || "";
          document.getElementById("pekerjaanAyah").value =
            savedData.pekerjaanAyah || "";
          document.getElementById("nohpAyah").value = savedData.nohpAyah || "";
          document.getElementById("penghasilanAyah").value =
            savedData.penghasilanAyah || "";
          document.getElementById("alamatAyah").value =
            savedData.alamatAyah || "";
          document.getElementById("namaIbu").value = savedData.namaIbu || "";
          document.getElementById("pekerjaanIbu").value =
            savedData.pekerjaanIbu || "";
          document.getElementById("nohpIbu").value = savedData.nohpIbu || "";
          document.getElementById("penghasilanIbu").value =
            savedData.penghasilanIbu || "";
          document.getElementById("alamatIbu").value =
            savedData.alamatIbu || "";
        }
      }

      function getAllFormData() {
        return window.formDataStorage;
      }

      function clearAllFormData() {
        window.formDataStorage = {};
      }

      // Auto-save functionality
      let autoSaveTimer;
      const formInputs = document.querySelectorAll(".form-control");

      formInputs.forEach((input) => {
        input.addEventListener("input", function () {
          clearTimeout(autoSaveTimer);
          autoSaveTimer = setTimeout(() => {
            console.log("Auto-saving draft...");
            handleSaveDraft();
          }, 5000); // Auto-save after 5 seconds of inactivity
        });
      });

      // Animate progress on load
      window.addEventListener("load", function () {
        setTimeout(() => {
          document.getElementById("progressFill").style.width = "40%";
        }, 100);
      });

      // Show notification function
      function showNotification(type, title, message) {
        const notification = document.getElementById("notification");
        const icon = notification.querySelector("i");
        const titleElement = document.getElementById("notification-title");
        const messageElement = document.getElementById("notification-message");

        // Update notification content
        titleElement.textContent = title;
        messageElement.textContent = message;

        // Update notification type
        notification.className = "notification " + type;

        // Update icon
        if (type === "success") {
          icon.className = "fas fa-check-circle";
        } else if (type === "error") {
          icon.className = "fas fa-exclamation-circle";
        } else if (type === "info") {
          icon.className = "fas fa-info-circle";
        }

        // Show notification
        notification.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // Phone number validation
      document
        .getElementById("nohpAyah")
        .addEventListener("input", function (e) {
          this.value = this.value.replace(/[^0-9]/g, "");
        });

      document
        .getElementById("nohpIbu")
        .addEventListener("input", function (e) {
          this.value = this.value.replace(/[^0-9]/g, "");
        });

      // Replace alert with showNotification in form submission
      const originalAlert = window.alert;
      window.alert = function (message) {
        // Convert alert to notification
        showNotification("info", "Informasi", message);
      };
    </script>
  </body>
</html>
